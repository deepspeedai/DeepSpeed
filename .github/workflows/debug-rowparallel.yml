name: debug-rowparallel

on:
  workflow_dispatch:

jobs:
  debug-test:
    name: Debug RowParallel Test
    runs-on: [self-hosted, gpu-ci, gpu-l40s, l40s-4gpu, aws]
    timeout-minutes: 30

    container:
      image: nvidia/cuda:12.6.3-devel-ubuntu22.04
      options: --gpus all --shm-size "32G"

    steps:
      - name: Install system dependencies
        run: |
          apt-get update && apt-get install -y git python3 python3-pip
          ln -sf /usr/bin/python3 /usr/bin/python

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PyTorch
        run: |
          pip install torch==2.7.1 --index-url https://download.pytorch.org/whl/cu126

      - name: Install DeepSpeed
        run: |
          pip install .[dev]

      - name: Show GPU info
        run: |
          nvidia-smi
          python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}'); print(f'GPU: {torch.cuda.get_device_name(0)}'); print(f'BF16 supported: {torch.cuda.is_bf16_supported()}')"

      - name: Run debug test
        run: |
          cd tests
          python -m pytest unit/model_parallelism/test_rowparallel_debug.py -v -s 2>&1 | tee rowparallel_debug_output.txt
          
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-output
          path: tests/rowparallel_debug_output.txt
