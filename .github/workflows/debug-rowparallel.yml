name: debug-rowparallel

on:
  workflow_dispatch:

jobs:
  debug-test:
    name: Debug RowParallel Test
    runs-on: [self-hosted, gpu-ci, gpu-l40s, l40s-4gpu, aws]
    timeout-minutes: 60

    container:
      image: nvidia/cuda:12.6.3-devel-ubuntu22.04
      options: --gpus all --shm-size "32G"

    steps:
      - name: Install system dependencies
        run: |
          apt-get update && apt-get install -y git python3 python3-pip
          ln -sf /usr/bin/python3 /usr/bin/python

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PyTorch
        run: |
          pip install torch==2.7.1 --index-url https://download.pytorch.org/whl/cu126

      - name: Install DeepSpeed
        run: |
          pip install .[dev]

      - name: Show GPU info
        run: |
          nvidia-smi
          python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}'); print(f'GPU: {torch.cuda.get_device_name(0)}'); print(f'BF16 supported: {torch.cuda.is_bf16_supported()}')"

      - name: Run testRowParallel with 5 different seeds
        run: |
          cd tests
          echo "=== Running testRowParallel[False-2] with 5 different random seeds ===" | tee debug_output.txt
          for seed in 111 222 333 444 555; do
            echo "" | tee -a debug_output.txt
            echo "=== Seed $seed ===" | tee -a debug_output.txt
            python -m pytest "unit/model_parallelism/test_autotp_training.py::TestTpLayerFwdBwd::testRowParallel[False-2]" \
              -v -s -m sequential --randomly-seed=$seed 2>&1 | tee -a debug_output.txt || true
          done

      - name: Run full sequential tests with seed 1
        run: |
          cd tests
          echo "" | tee -a debug_output.txt
          echo "=== Full sequential tests with seed 1 ===" | tee -a debug_output.txt
          python -m pytest unit/ -v -m sequential --randomly-seed=1 \
            --ignore=unit/runtime/zero/test_nvme_checkpointing.py \
            --ignore=unit/ops/aio/test_gds.py \
            --ignore=unit/launcher/test_user_args.py \
            --ignore=unit/runtime/zenflow \
            --ignore=unit/ops/adam/test_zf_torch_adam.py \
            2>&1 | tee -a debug_output.txt || true

      - name: Run full sequential tests with seed 2
        run: |
          cd tests
          echo "" | tee -a debug_output.txt
          echo "=== Full sequential tests with seed 2 ===" | tee -a debug_output.txt
          python -m pytest unit/ -v -m sequential --randomly-seed=2 \
            --ignore=unit/runtime/zero/test_nvme_checkpointing.py \
            --ignore=unit/ops/aio/test_gds.py \
            --ignore=unit/launcher/test_user_args.py \
            --ignore=unit/runtime/zenflow \
            --ignore=unit/ops/adam/test_zf_torch_adam.py \
            2>&1 | tee -a debug_output.txt || true

      - name: Run full sequential tests with seed 3
        run: |
          cd tests
          echo "" | tee -a debug_output.txt
          echo "=== Full sequential tests with seed 3 ===" | tee -a debug_output.txt
          python -m pytest unit/ -v -m sequential --randomly-seed=3 \
            --ignore=unit/runtime/zero/test_nvme_checkpointing.py \
            --ignore=unit/ops/aio/test_gds.py \
            --ignore=unit/launcher/test_user_args.py \
            --ignore=unit/runtime/zenflow \
            --ignore=unit/ops/adam/test_zf_torch_adam.py \
            2>&1 | tee -a debug_output.txt || true
          
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-output
          path: tests/debug_output.txt
